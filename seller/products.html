<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="../css/bootstrap.css">
    <link rel="stylesheet" href="../css/bootstrap-theme.css">
    <link rel="stylesheet" href="../css/mpopup.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        button[name="edit"],
        button:active[name="edit"],
        button:focus[name="edit"] {
            background: none;
            outline: none;
        }

        .product-info{
            margin-top: 8px;
        }

        a[data-action="edit"]{
            color: #000;
            text-decoration: none;
        }

        .product_item_type:before{
            content: "Type: "
        }

        .product_item_price:before {
            content: '$'
        }
    </style>

    <script src="../js/vendor/modernizr-2.6.2.min.js"></script>
</head>
<body>

<!-- add/edit product dialog-->
<div id="add-product-dialog" class="mfp-hide container dialog-body">
    <div class="row">
        <div class="page-header text-center" style="margin-top: 0px">
            <h4 class="dialog-header"><span id="dialog-action">Add/Edit</span> Product</h4>
        </div>

            <div class="col-xs-12">
                <form class="form-horizontal" role="form">
                    <div class="form-group">
                        <label for="prodName" class="col-sm-3 control-label">Name</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" id="prodName" placeholder="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="prodType" class="col-sm-3 control-label">Type</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" id="prodType" placeholder="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="mfgDate" class="col-sm-3 control-label">Mfg. Date</label>
                        <div class="col-sm-8">
                            <input type="date" class="form-control" id="mfgDate" placeholder="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="expDate" class="col-sm-3 control-label">Exp. Date</label>
                        <div class="col-sm-8">
                            <input type="date" class="form-control" id="expDate" placeholder="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inventoryLeft" class="col-sm-3 control-label">Inventory</label>
                        <div class="col-sm-8">
                            <input type="number" class="form-control" id="inventoryLeft" placeholder="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="item-price" class="col-sm-3 control-label">Price</label>
                        <div class="col-sm-8">
                            <input type="number" class="form-control" id="item-price" placeholder="">
                        </div>
                    </div>
                    <input type="hidden" id="item-address" name="address" />
                </form>
                <div class="text-center">
                    <button type="button" class="btn btn-success btn-sm" data-type="save">Save</button>
                    <button type="button" class="btn btn-danger btn-sm" data-type="cancel">Cancel</button>
                </div>

            </div>
    </div>
</div>



<!--[if lt IE 7]>
<p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../index.html">ALWAYSTOCKED.COM</a>
        </div>
        <div class="navbar-collapse collapse">
            <a href="#" data-action="logout" class="navbar-right navbar-btn btn btn-warning hidden-xs signout">
                <span class="glyphicon glyphicon-off"></span> Sign out
            </a>
            <a href="#" data-action="logout" class="navbar-right navbar-btn btn btn-warning btn-block visible-xs signout">
                <span class="glyphicon glyphicon-off"></span> Sign out
            </a>

            <a href="#" data-mfp-src="#add-product-dialog" data-action="add" class="dialog navbar-right navbar-btn btn btn-primary hidden-xs">
                <span class="glyphicon glyphicon-plus"></span> Add New Product
            </a>
            <a href="#" data-mfp-src="#add-product-dialog" data-action="add" class="dialog navbar-right navbar-btn btn btn-primary btn-block visible-xs">
                <span class="glyphicon glyphicon-plus"></span> Add New Product
            </a>
        </div><!--/.navbar-collapse end -->
    </div>
</div>

<!-- Main container -->
<div class="container">

    <div class="page-header">
        <h3>My Products</h3>
    </div>

    <div class="row">
        <div class="col-sm-8 col-sm-offset-2">

            <div class="products-table col-xs-12">
                <!-- thead -->
                <div style="display:table-row; font-size: 14px; font-weight: bold; border-bottom: 2px solid #ccc; margin-bottom: 10px;">
                    <div class="col-sm-8 tablecell">
                        Product Info
                    </div>
                    <div class="col-sm-3 tablecell">
                        Inventory
                    </div>
                    <div class="col-sm-1 tablecell center-block">
                        Edit
                    </div>
                    <div class="clearfix"></div>
                </div>

                <!-- tbody -->
                <!-- products list go here-->

            </div>

        </div>
    </div> <!-- row end -->
</div>    <!-- container end -->

<!-- site scripts -->
<script type="text/template" id="product-listing-template">
    <div class="product-info">
        <div class="col-sm-8 tablecell" style="padding-top: 10px;">
            <strong id="prod_name">{productName}</strong>
            <br>
            <em id="prod_type" class="product_item_type small">{productType}</em>
            <ul class="small">
                <li>Mfg Date: <span id="mfg_date">{manufacturingDate}</span></li>
                <li>Exp Date: <span id="exp_date">{expiryDate}</span></li>
                <li>Unit Price: <span id="price" class="product_item_price" >{price}</span></li>
            </ul>
        </div>
        <div class="col-sm-3 tablecell" style="padding-top: 10px;">
            <p><span id="num_left">{quantity}</span></p>
        </div>
        <div class="col-sm-1 tablecell" style="padding-top: 10px;">
            <a href="#" data-id="{productName}" data-action="edit" data-mfp-src="#add-product-dialog" class="btn btn-sm dialog"><span class="glyphicon glyphicon-pencil"></span></a>
            <a href="#" data-id="{productName}" data-action="delete" class="btn btn-sm"><span class="glyphicon glyphicon-trash" style="color:red;"></span></a>
        </div>
    </div>

</script>
<script src="../js/vendor/jquery-1.11.0.min.js"></script>
<script src="../js/vendor/bootstrap.js"></script>
<script src="../js/vendor/mpopup.js"></script>
<script src="../js/plugins.js"></script>
<script src="../js/main.js"></script>
<script src="../js/common.js"></script>

<script>
    redirectAuthFailToHome();

    $(function(){

        $('.products-table').on('click', "a[data-action='delete']", function(){
            var $row = $(this).closest('.product-info');
            var onDeleteError = function(e){
                console.log("deletion error", e);
                alert("Sorry, some error happened during product deletion process");
            };
            console.log('deleting product=' + $(this).data('id'));
            deleteSellerProduct($(this).data('id'), function(data){
                if(data.error){
                    onDeleteError(data);
                    return;
                }
                console.log("deletion successful");
                $row.remove();
            }, onDeleteError);
        });

        // fetch all seller products and list them on the page
        getSpecificSellerProducts(getLoggedInUserData('email'), function(d){
            var data = d && d.response && d.response.marshallableProduct;
            if(data){
                for(var i = 0; i < data.length; i++){
                    var product = data[i] && data[i].wrappedProduct;
                    if(!product){
                        continue;
                    }
                    insertNewProductOnPage({
                        productName: product.productName,
                        productType: product.productType,
                        manufacturingDate: new Date(product.manufacturingDate).format('mm/dd/yyyy', true),
                        expiryDate: new Date(product.expiryDate).format('mm/dd/yyyy', true),
                        quantity: product.quantity,
                        price: parseFloat(product.price).toFixed(2)
                    });
                }
            } else {
                alert("Some error occured while fetching the products");
            }
        }, function(e){
            alert("Some error occured while fetching the products for this seller from server.");
        });

        //initialize page
        attachPopup($('.dialog'));

        $('#add-product-dialog button[type="button"]').on('click', function(e){
            var targetType = $(e.target).data('type'),
                prodName, prodType, mfgDate, expDate, numLeft, price, $triggerElem, $popupElem, $productInfoContainer;

            if(targetType === 'cancel'){
                $.magnificPopup.instance.close();
            } else if(targetType === 'save'){
                $triggerElem = $($.magnificPopup.instance.currItem.el);
                $productInfoContainer = $triggerElem.closest('.product-info');
                $popupElem = $($.magnificPopup.instance.currItem.inlineElement);

                prodName = $popupElem.find('#prodName').val();
                prodType = $popupElem.find('#prodType').val();
                mfgDate = $popupElem.find('#mfgDate').val();
                expDate = $popupElem.find('#expDate').val();
                numLeft = parseInt($popupElem.find('#inventoryLeft').val(), 10);
                price = $popupElem.find('#item-price').val();

                if($triggerElem.data('action') === 'add'){
                    saveNewProduct({
                        productName: prodName,
                        productType: prodType,
                        manufacturingDate: +new Date(mfgDate),
                        expiryDate: +new Date(expDate),
                        quantity: numLeft,
                        price: price
                    }, function(d){
                        console.log("add prod success", d);
                        var prodSaveData = d && d.response && d.response.wrappedProduct;
                        prodSaveData && insertNewProductOnPage({
                            productName: prodSaveData.productName,
                            productType: prodSaveData.productType,
                            manufacturingDate: new Date(prodSaveData.manufacturingDate).format('mm/dd/yyyy', true),
                            expiryDate: new Date(prodSaveData.expiryDate).format('mm/dd/yyyy', true),
                            quantity: prodSaveData.quantity,
                            price: parseFloat(prodSaveData.price).toFixed(2)
                        });
                    }, function (e) {
                        console.log("add prod error", e);
                    });
                } else if($triggerElem.data('action') === 'edit'){
                    var onEditError = function(e){
                        console.log("error during product data edit", e);
                        alert("Some error occurred while saving data to server. Please try again");
                    };
                    updateSellerProduct({
                        productName: prodName,
                        productType: prodType,
                        manufacturingDate: +new Date(mfgDate),
                        expiryDate: +new Date(expDate),
                        quantity: numLeft,
                        price: price
                    }, function(data){
                        if(data.error){
                            onEditError(data);
                            return;
                        }
                        $productInfoContainer.find('#prod_name').html(prodName);
                        $productInfoContainer.find('#prod_type').html(prodType);
                        $productInfoContainer.find('#mfg_date').html(new Date(mfgDate).format('mm/dd/yyyy',true));
                        $productInfoContainer.find('#exp_date').html(new Date(expDate).format('mm/dd/yyyy',true));
                        $productInfoContainer.find('#num_left').html(numLeft);
                        $productInfoContainer.find('#price').html(price);
                    }, onEditError);
                }

                $.magnificPopup.instance.close();
            }
        });
    });

    function insertNewProductOnPage(prodData){
        var template = $('#product-listing-template').html();
        var html = strSubstitute(template,prodData);
        var newNode = $(html).appendTo($(".products-table"));
        attachPopup(newNode.find('a[class~=dialog]'));
    }

    function attachPopup($elem){
        $elem.magnificPopup({
            type: 'inline',
            fixedContentPos: false,
            fixedBgPos: true,
            overflowY:'auto',
            closeBtnInside: true,
            midClick: true,
            removalDelay: 300,
            mainClass: 'my-mfp-slide-bottom',
            callbacks: {
                elementParse: function(e){
                    var targetAction = $(e.el[0]).data('action'),
                            $productInfoContainer;
                    //console.log(e);
                    if(targetAction === 'add'){
                        $('#dialog-action').html('Add');
                        $('#prodName').val("");
                        $('#prodType').val("");
                        $('#mfgDate').val("");
                        $('#expDate').val("");
                        $('#inventoryLeft').val("");
                        $('#item-price').val("");
                        $("#prodName").prop('disabled', false);

                    } else if (targetAction === 'edit'){
                        $('#dialog-action').html('Edit');
                        $productInfoContainer = $(e.el[0]).closest('.product-info');
                        $('#prodName').val($productInfoContainer.find('#prod_name').html() || "");
                        $('#prodType').val($productInfoContainer.find('#prod_type').html() || "");
                        $('#mfgDate').val(new Date($productInfoContainer.find('#mfg_date').html()).format('yyyy-mm-dd',true) || "");
                        $('#expDate').val(new Date($productInfoContainer.find('#exp_date').html()).format('yyyy-mm-dd',true) || "");
                        $('#inventoryLeft').val($productInfoContainer.find('#num_left').html() || "");
                        $('#item-price').val($productInfoContainer.find('#price').html() || "");
                        $("#prodName").prop('disabled', true);
                    }

                    $('#item-address').val(getLoggedInUserData('address'));


                }
            }
        });
    }

</script>
</body>
</html>
